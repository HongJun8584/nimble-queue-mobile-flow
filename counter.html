
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter - Queue Joy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .slide-up { animation: slideUp 0.6s ease-out; }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .call-animation { animation: callPulse 0.5s ease-in-out; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes callPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .ad-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 8px;
            text-align: center;
            z-index: 40;
        }
        .ad-banner img {
            max-height: 60px;
            max-width: 100%;
            object-fit: contain;
        }
        .content-with-ad {
            padding-bottom: 80px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen content-with-ad">
    <!-- Hamburger Menu -->
    <div class="fixed top-4 left-4 z-50">
        <button id="hamburgerBtn" class="p-3 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg hover:bg-white transition-all duration-200">
            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                <span class="block w-full h-0.5 bg-gray-600"></span>
                <span class="block w-full h-0.5 bg-gray-600"></span>
                <span class="block w-full h-0.5 bg-gray-600"></span>
            </div>
        </button>
    </div>

    <!-- Navigation Menu -->
    <div id="navMenu" class="fixed inset-0 bg-black/50 z-40 hidden">
        <div class="fixed left-0 top-0 h-full w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300" id="navPanel">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Queue Joy</h2>
                <nav class="space-y-3">
                    <a href="./index.html" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-colors font-medium">üè† Home</a>
                    <a href="./status.html" id="statusLink" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-colors font-medium hidden">üìä Status</a>
                    <a href="./game.html" id="gameLink" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-colors font-medium hidden">üéÆ Game</a>
                    <a href="./counter.html" class="block px-4 py-3 bg-indigo-100 text-indigo-600 rounded-xl font-medium">üéØ Counter</a>
                </nav>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 slide-up">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">üîê Counter Access</h2>
            <p class="text-gray-600 text-center mb-6">Enter PIN to access counter</p>
            
            <div class="mb-4">
                <input id="pinInput" type="password" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                       class="w-full p-3 text-center text-2xl border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none">
                <div id="pinError" class="text-red-500 text-sm mt-2 text-center hidden">‚ùå Incorrect PIN</div>
            </div>

            <button id="submitPinBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-bold rounded-xl hover:scale-105 transition-all">
                Submit
            </button>
        </div>
    </div>

    <!-- Counter Setup Modal -->
    <div id="setupModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 slide-up">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">‚öôÔ∏è Counter Setup</h2>
            <p class="text-gray-600 text-center mb-6">Configure your counter</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Counter Number</label>
                <select id="counterSelect" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none">
                    <option value="">Choose Counter...</option>
                    <option value="counter1">Counter 1</option>
                    <option value="counter2">Counter 2</option>
                    <option value="counter3">Counter 3</option>
                    <option value="counter4">Counter 4</option>
                    <option value="counter5">Counter 5</option>
                    <option value="counter6">Counter 6</option>
                    <option value="counter7">Counter 7</option>
                    <option value="counter8">Counter 8</option>
                    <option value="counter9">Counter 9</option>
                    <option value="counter10">Counter 10</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Enter Prefix (A-Z only)</label>
                <input id="prefixInput" type="text" maxlength="5" placeholder="ABC" 
                       class="w-full p-3 text-center text-lg border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none uppercase">
                <div id="prefixError" class="text-red-500 text-sm mt-1 hidden">Only uppercase letters allowed</div>
            </div>

            <button id="setupSubmit" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-bold rounded-xl hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Setup Counter
            </button>
            <div id="setupStatus" class="text-center text-sm mt-2 min-h-[20px]"></div>
        </div>
    </div>

    <!-- Main Counter Panel -->
    <div id="counterPanel" class="min-h-screen flex flex-col justify-center items-center px-4 py-8 max-w-sm mx-auto text-center bg-white rounded-xl shadow-md gap-4 hidden">
        
        <!-- Header -->
        <div class="w-full mb-2">
            <h1 class="text-2xl font-bold text-gray-800" id="counterTitle">Counter Management</h1>
            <p class="text-gray-600">Queue Joy System</p>
        </div>

        <!-- Now Serving Display -->
        <div class="w-full bg-indigo-50 rounded-2xl p-6 mb-4">
            <p class="text-sm text-gray-600 mb-2">Now Serving</p>
            <p id="nowServing" class="text-4xl font-bold text-indigo-600">Ready</p>
        </div>

        <!-- Quick Stats -->
        <div class="w-full grid grid-cols-3 gap-3 mb-4">
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-xs text-gray-600">Prefix</p>
                <p id="queuePrefix" class="text-lg font-bold text-gray-800">-</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-xs text-gray-600">Last Called</p>
                <p id="lastCalled" class="text-lg font-bold text-gray-800">--</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-xs text-gray-600">In Queue</p>
                <p id="peopleInQueue" class="text-lg font-bold text-gray-800">0</p>
            </div>
        </div>

        <!-- Main Action Buttons -->
        <button id="callNextBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-500 text-white text-xl font-bold rounded-xl hover:scale-105 transition-all shadow-lg">
            ‚ñ∂Ô∏è Call Next
        </button>

        <button id="recallBtn" class="w-full py-3 bg-yellow-500 text-white text-lg font-semibold rounded-xl hover:scale-105 transition-all">
            üîÅ Recall Last
        </button>

        <!-- Skip to Number -->
        <div class="w-full mt-4">
            <input id="skipInput" class="w-full text-center border-2 border-gray-300 rounded-xl p-3 mb-2 text-lg focus:border-indigo-500 focus:outline-none" placeholder="Skip to number (e.g. ABC110)">
            <button id="skipBtn" class="w-full py-3 bg-red-500 text-white font-semibold rounded-xl hover:scale-105 transition-all">
                ‚è© Skip to Number
            </button>
        </div>

        <!-- Action Status -->
        <p id="actionStatus" class="text-sm text-gray-500 min-h-[20px]"></p>

    </div>

    <!-- Ad Banner -->
    <div id="adBanner" class="ad-banner hidden">
        <img id="adImage" src="" alt="Advertisement" />
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="./js/firebase-config.js"></script>
    
    <script>
        let callSound = null;
        let currentCounterId = null;
        let currentPrefix = null;
        let currentNumber = 101;
        let firebaseListeners = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Counter system initializing...');
            
            initializeAudio();
            setupNavigation();
            checkPinAccess();
            updateMenuVisibility();
        });

        // Initialize audio
        function initializeAudio() {
            try {
                callSound = new Howl({
                    src: ['data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'],
                    volume: 0.7
                });
            } catch (error) {
                console.warn('‚ö†Ô∏è Audio initialization failed');
            }
        }

        // Navigation setup
        function setupNavigation() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const navMenu = document.getElementById('navMenu');
            const navPanel = document.getElementById('navPanel');

            hamburgerBtn.addEventListener('click', function() {
                navMenu.classList.remove('hidden');
                setTimeout(() => {
                    navPanel.style.transform = 'translateX(0)';
                }, 10);
            });

            navMenu.addEventListener('click', function(e) {
                if (e.target === navMenu) {
                    navPanel.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        navMenu.classList.add('hidden');
                    }, 300);
                }
            });
        }

        // Update menu visibility based on user status
        function updateMenuVisibility() {
            const queueId = localStorage.getItem('queueId');
            const statusLink = document.getElementById('statusLink');
            const gameLink = document.getElementById('gameLink');
            
            if (queueId) {
                statusLink.classList.remove('hidden');
                gameLink.classList.remove('hidden');
            } else {
                statusLink.classList.add('hidden');
                gameLink.classList.add('hidden');
            }
        }

        // Check PIN access
        function checkPinAccess() {
            const pinAccess = sessionStorage.getItem('pinAccess');
            const savedCounterId = sessionStorage.getItem('counterId');
            const savedPrefix = sessionStorage.getItem('prefix');
            
            if (pinAccess === 'granted') {
                if (savedCounterId && savedPrefix) {
                    // Counter already set up
                    currentCounterId = savedCounterId;
                    currentPrefix = savedPrefix;
                    document.getElementById('pinModal').classList.add('hidden');
                    showCounterPanel();
                } else {
                    // Need setup
                    document.getElementById('pinModal').classList.add('hidden');
                    showSetupModal();
                }
            } else {
                // Show PIN modal
                setupPinModal();
            }
        }

        // Setup PIN modal
        function setupPinModal() {
            const pinInput = document.getElementById('pinInput');
            const submitBtn = document.getElementById('submitPinBtn');
            const pinError = document.getElementById('pinError');

            submitBtn.addEventListener('click', function() {
                const pin = pinInput.value.trim();
                if (pin === '0108') {
                    sessionStorage.setItem('pinAccess', 'granted');
                    document.getElementById('pinModal').classList.add('hidden');
                    showSetupModal();
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            });

            pinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitBtn.click();
                }
            });

            pinInput.focus();
        }

        // Show setup modal
        function showSetupModal() {
            const setupModal = document.getElementById('setupModal');
            const counterSelect = document.getElementById('counterSelect');
            const prefixInput = document.getElementById('prefixInput');
            const setupSubmit = document.getElementById('setupSubmit');
            const prefixError = document.getElementById('prefixError');
            const setupStatus = document.getElementById('setupStatus');

            setupModal.classList.remove('hidden');

            // Validation
            function validateForm() {
                const counter = counterSelect.value;
                const prefix = prefixInput.value.trim();
                const isValidPrefix = /^[A-Z]+$/.test(prefix);
                
                if (prefix.length > 0 && !isValidPrefix) {
                    prefixError.classList.remove('hidden');
                } else {
                    prefixError.classList.add('hidden');
                }

                setupSubmit.disabled = !(counter && prefix && isValidPrefix);
            }

            counterSelect.addEventListener('change', validateForm);
            prefixInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                validateForm();
            });

            setupSubmit.addEventListener('click', function() {
                const counter = counterSelect.value;
                const prefix = prefixInput.value.trim();

                if (counter && prefix && /^[A-Z]+$/.test(prefix)) {
                    setupStatus.textContent = 'Setting up counter...';
                    setupStatus.className = 'text-center text-sm mt-2 min-h-[20px] text-blue-600';

                    const database = firebase.database();
                    const counterData = {
                        prefix: prefix,
                        current: 101,
                        lastSuffix: 101,
                        createdAt: Date.now()
                    };

                    database.ref(`settings/counters/${counter}`).set(counterData).then(() => {
                        currentCounterId = counter;
                        currentPrefix = prefix;
                        currentNumber = 101;
                        
                        // Save to session
                        sessionStorage.setItem('counterId', counter);
                        sessionStorage.setItem('prefix', prefix);
                        
                        setupStatus.textContent = '‚úÖ Counter setup complete';
                        setupStatus.className = 'text-center text-sm mt-2 min-h-[20px] text-green-600';
                        
                        setTimeout(() => {
                            setupModal.classList.add('hidden');
                            showCounterPanel();
                        }, 1000);
                    }).catch((error) => {
                        console.error('Error saving counter config:', error);
                        setupStatus.textContent = '‚ùå Failed to setup counter';
                        setupStatus.className = 'text-center text-sm mt-2 min-h-[20px] text-red-600';
                    });
                }
            });
        }

        // Show counter panel
        function showCounterPanel() {
            const counterPanel = document.getElementById('counterPanel');
            const counterTitle = document.getElementById('counterTitle');
            const queuePrefix = document.getElementById('queuePrefix');
            const nowServing = document.getElementById('nowServing');
            const lastCalled = document.getElementById('lastCalled');

            counterTitle.textContent = `${currentCounterId.charAt(0).toUpperCase() + currentCounterId.slice(1)} Management`;
            queuePrefix.textContent = currentPrefix;
            
            // Load current state from Firebase
            if (typeof firebase !== 'undefined' && firebase.database) {
                const database = firebase.database();
                const counterRef = database.ref(`settings/counters/${currentCounterId}`);
                
                counterRef.on('value', (snapshot) => {
                    const config = snapshot.val();
                    if (config) {
                        currentNumber = config.current || 101;
                        const currentNumberStr = `${currentPrefix}${currentNumber.toString().padStart(3, '0')}`;
                        nowServing.textContent = currentNumber > 101 ? currentNumberStr : 'Ready';
                        lastCalled.textContent = currentNumber > 101 ? currentNumberStr : '--';
                    }
                });
                firebaseListeners.push(counterRef);
                
                loadAdBanner();
                updateQueueStats();
            }

            counterPanel.classList.remove('hidden');
            setupEventListeners();
        }

        // Load ad banner
        function loadAdBanner() {
            const database = firebase.database();
            const adBannerRef = database.ref('settings/adBanner');
            
            adBannerRef.on('value', (snapshot) => {
                const adUrl = snapshot.val();
                const adBanner = document.getElementById('adBanner');
                const adImage = document.getElementById('adImage');
                
                if (adUrl && adUrl.trim()) {
                    adImage.src = adUrl;
                    adBanner.classList.remove('hidden');
                } else {
                    adBanner.classList.add('hidden');
                }
            });
            firebaseListeners.push(adBannerRef);
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('callNextBtn').addEventListener('click', callNextNumber);
            document.getElementById('recallBtn').addEventListener('click', recallLastNumber);
            document.getElementById('skipBtn').addEventListener('click', skipToNumber);
        }

        // Update queue statistics
        function updateQueueStats() {
            const database = firebase.database();
            const today = new Date().toISOString().split('T')[0];
            
            database.ref(`queues/${today}/${currentCounterId}`).once('value', (snapshot) => {
                const queue = snapshot.val() || {};
                const waitingCount = Object.values(queue).filter(item => item.status === 'waiting').length;
                document.getElementById('peopleInQueue').textContent = waitingCount;
            });
        }

        // Call next number
        function callNextNumber() {
            const database = firebase.database();
            const today = new Date().toISOString().split('T')[0];
            
            // Find next waiting number
            database.ref(`queues/${today}/${currentCounterId}`).orderByChild('status').equalTo('waiting').limitToFirst(1).once('value', (snapshot) => {
                const queue = snapshot.val();
                
                if (queue && Object.keys(queue).length > 0) {
                    // Call the next waiting number
                    const nextQueueId = Object.keys(queue)[0];
                    const nextQueueData = queue[nextQueueId];
                    
                    // Update counter and queue status
                    const newCurrent = parseInt(nextQueueData.number.replace(currentPrefix, ''));
                    const updates = {};
                    updates[`settings/counters/${currentCounterId}/current`] = newCurrent;
                    updates[`queues/${today}/${currentCounterId}/${nextQueueId}/status`] = 'serving';
                    updates[`queues/${today}/${currentCounterId}/${nextQueueId}/calledAt`] = Date.now();
                    
                    database.ref().update(updates).then(() => {
                        playCallSound();
                        showStatus(`‚úÖ Called ${nextQueueData.number}`, 'success');
                        
                        // Visual feedback
                        const servingElement = document.getElementById('nowServing');
                        servingElement.classList.add('call-animation');
                        setTimeout(() => servingElement.classList.remove('call-animation'), 500);
                        
                        updateQueueStats();
                    });
                } else {
                    showStatus('No customers in queue', 'warning');
                }
            });
        }

        // Recall last number
        function recallLastNumber() {
            const serving = document.getElementById('nowServing').textContent;
            if (serving === 'Ready' || serving === '--') {
                showStatus('No number to recall', 'warning');
                return;
            }
            
            playCallSound();
            showStatus(`üîÅ Recalled ${serving}`, 'success');
            
            const servingElement = document.getElementById('nowServing');
            servingElement.classList.add('call-animation');
            setTimeout(() => servingElement.classList.remove('call-animation'), 500);
        }

        // Skip to number
        function skipToNumber() {
            const skipInput = document.getElementById('skipInput');
            const number = skipInput.value.trim().toUpperCase();
            
            if (!number || !number.startsWith(currentPrefix)) {
                showStatus(`‚ùå Invalid format. Use ${currentPrefix}001, ${currentPrefix}002, etc.`, 'error');
                return;
            }

            const suffix = parseInt(number.replace(currentPrefix, ''));
            if (isNaN(suffix) || suffix < 1) {
                showStatus('‚ùå Invalid number', 'error');
                return;
            }

            const database = firebase.database();
            database.ref(`settings/counters/${currentCounterId}/current`).set(suffix).then(() => {
                playCallSound();
                showStatus(`‚è© Skipped to ${number}`, 'success');
                skipInput.value = '';
            }).catch(() => {
                showStatus('‚ùå Failed to skip to number', 'error');
            });
        }

        // Play call sound
        function playCallSound() {
            if (callSound) {
                callSound.play();
            }
            
            if ('speechSynthesis' in window) {
                const serving = document.getElementById('nowServing').textContent;
                const counterName = currentCounterId.replace('counter', 'Counter ');
                const utterance = new SpeechSynthesisUtterance(`Number ${serving}, please proceed to ${counterName}`);
                utterance.volume = 0.7;
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('actionStatus');
            statusElement.textContent = message;
            statusElement.className = `text-sm min-h-[20px] ${
                type === 'success' ? 'text-green-600' :
                type === 'error' ? 'text-red-600' :
                type === 'warning' ? 'text-yellow-600' :
                'text-gray-500'
            }`;
            
            // Clear after 3 seconds
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'text-sm text-gray-500 min-h-[20px]';
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            firebaseListeners.forEach(ref => {
                if (ref && ref.off) ref.off();
            });
        });
    </script>
</body>
</html>
