
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter Management - Queue Joy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Howler.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .slide-up { animation: slideUp 0.6s ease-out; }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .call-animation { animation: callPulse 0.5s ease-in-out; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes callPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-warning {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Hamburger Menu -->
    <div class="fixed top-6 left-6 z-50">
        <button id="hamburgerBtn" class="bg-white/90 backdrop-blur-sm p-4 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-110">
            <div class="flex flex-col gap-1">
                <span class="w-6 h-0.5 bg-gray-700 rounded transition-all"></span>
                <span class="w-6 h-0.5 bg-gray-700 rounded transition-all"></span>
                <span class="w-6 h-0.5 bg-gray-700 rounded transition-all"></span>
            </div>
        </button>
        
        <div id="navPanel" class="absolute top-20 left-0 bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-6 w-52 hidden transform transition-all duration-300">
            <a href="./index.html" class="block py-3 px-4 text-gray-700 hover:bg-purple-50 rounded-xl transition-all duration-200">üè† Home</a>
            <a href="./status.html" class="block py-3 px-4 text-gray-700 hover:bg-purple-50 rounded-xl transition-all duration-200">üìä Status</a>
            <a href="./admin.html" class="block py-3 px-4 text-gray-700 hover:bg-purple-50 rounded-xl transition-all duration-200">‚öôÔ∏è Admin</a>
            <a href="#" class="block py-3 px-4 text-gray-700 hover:bg-purple-50 rounded-xl transition-all duration-200 bg-purple-50">üéØ Counter</a>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 slide-up">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">üîê Staff Login</h2>
            <p class="text-gray-600 text-center mb-6">Enter PIN to access counter panel</p>
            <input id="pinInput" type="password" maxlength="4" placeholder="0000" class="w-full p-4 text-center text-2xl border-2 border-gray-300 rounded-xl mb-4 focus:border-purple-500 focus:outline-none">
            <div id="pinError" class="text-red-500 text-center mb-4 hidden">Incorrect PIN. Please try again.</div>
            <button id="pinSubmit" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-xl hover:shadow-lg transition-all">Enter</button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="counterPanel" class="container mx-auto px-4 py-8 hidden">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-white mb-2">üéØ Counter Management</h1>
            <p class="text-white/80">Staff Control Panel</p>
        </div>

        <!-- Warning Banner -->
        <div id="warningBanner" class="bg-red-500 text-white p-4 rounded-2xl mb-6 text-center font-bold pulse-warning hidden">
            ‚ö†Ô∏è Do not edit counter settings while customers are in queue
        </div>

        <!-- Counter Selection -->
        <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 mb-6 slide-up">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Select Counter</h2>
            <select id="counterSelect" class="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none">
                <option value="">-- Choose Counter --</option>
                <option value="A">Counter A</option>
                <option value="B">Counter B</option>
                <option value="C">Counter C</option>
            </select>
        </div>

        <!-- Main Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Queue Status -->
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 slide-up">
                <h2 class="text-xl font-bold text-gray-800 mb-6">üìä Queue Status</h2>
                
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <div class="text-sm text-gray-600 font-medium">Now Serving</div>
                        <div id="nowServing" class="text-3xl font-bold text-green-600 mt-1">--</div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <div class="text-sm text-gray-600 font-medium">Last Issued</div>
                        <div id="lastIssued" class="text-2xl font-bold text-blue-600 mt-1">--</div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <div class="text-sm text-gray-600 font-medium">Queue Length</div>
                        <div id="queueLength" class="text-2xl font-bold text-purple-600 mt-1">0</div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="mt-6 space-y-3">
                    <button id="callNextBtn" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        üì¢ Call Next Number
                    </button>
                    
                    <button id="resetQueueBtn" class="w-full py-4 bg-gradient-to-r from-red-500 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        üîÑ Reset Queue
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 slide-up">
                <h2 class="text-xl font-bold text-gray-800 mb-6">‚öôÔ∏è Counter Settings</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Counter Prefix</label>
                        <select id="prefixSelect" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none" disabled>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sequence Type</label>
                        <select id="sequenceType" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none" disabled>
                            <option value="sequential">Sequential (1, 2, 3...)</option>
                            <option value="odd">Odd Numbers (1, 3, 5...)</option>
                            <option value="even">Even Numbers (2, 4, 6...)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script src="./js/firebase-config.js"></script>
    
    <script>
        let currentCounter = null;
        let callSound = null;
        let firebaseListeners = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Counter system initializing...');
            initializeAuth();
            initializeNavigation();
            initializeAudio();
            setupEventListeners();
        });

        // Authentication
        function initializeAuth() {
            const pinModal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const pinSubmit = document.getElementById('pinSubmit');
            const pinError = document.getElementById('pinError');
            const counterPanel = document.getElementById('counterPanel');

            if (sessionStorage.getItem('counterAuth') === 'true') {
                showCounterPanel();
                return;
            }

            pinSubmit.addEventListener('click', handlePinSubmit);
            pinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handlePinSubmit();
            });

            function handlePinSubmit() {
                const pin = pinInput.value.trim();
                if (pin === '0108') {
                    sessionStorage.setItem('counterAuth', 'true');
                    pinModal.style.opacity = '0';
                    setTimeout(() => {
                        pinModal.classList.add('hidden');
                        showCounterPanel();
                    }, 300);
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            }

            function showCounterPanel() {
                counterPanel.classList.remove('hidden');
                initializeFirebase();
            }
        }

        // Navigation
        function initializeNavigation() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const navPanel = document.getElementById('navPanel');

            hamburgerBtn.addEventListener('click', function() {
                navPanel.classList.toggle('hidden');
            });

            document.addEventListener('click', function(e) {
                if (!navPanel.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                    navPanel.classList.add('hidden');
                }
            });
        }

        // Audio System
        function initializeAudio() {
            try {
                callSound = new Howl({
                    src: ['data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'],
                    volume: 0.7,
                    onload: function() {
                        console.log('üîä Audio system ready');
                    },
                    onloaderror: function() {
                        console.warn('‚ö†Ô∏è Audio loading failed, using fallback');
                        createFallbackSound();
                    }
                });
            } catch (error) {
                console.warn('‚ö†Ô∏è Howler.js failed, using fallback');
                createFallbackSound();
            }
        }

        function createFallbackSound() {
            callSound = {
                play: function() {
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance('Ding');
                        utterance.volume = 0.7;
                        speechSynthesis.speak(utterance);
                    }
                }
            };
        }

        // Firebase System
        function initializeFirebase() {
            if (typeof firebase === 'undefined' || !firebase.database) {
                console.error('‚ùå Firebase not available');
                return;
            }

            const database = firebase.database();
            
            // Listen for all counters data
            const countersRef = database.ref('queue');
            countersRef.on('value', (snapshot) => {
                const queueData = snapshot.val() || {};
                updateUI(queueData);
                checkQueueStatus(queueData);
            }, (error) => {
                console.error('‚ùå Firebase read error:', error);
            });

            firebaseListeners.push({ ref: countersRef, type: 'value' });
        }

        // Event Listeners
        function setupEventListeners() {
            const counterSelect = document.getElementById('counterSelect');
            counterSelect.addEventListener('change', function() {
                currentCounter = this.value;
                if (currentCounter) {
                    enableCounterControls();
                    loadCounterSettings();
                } else {
                    disableCounterControls();
                }
            });

            document.getElementById('callNextBtn').addEventListener('click', callNextNumber);
            document.getElementById('resetQueueBtn').addEventListener('click', resetQueue);
            document.getElementById('prefixSelect').addEventListener('change', saveCounterSettings);
            document.getElementById('sequenceType').addEventListener('change', saveCounterSettings);
        }

        // Counter Operations
        function callNextNumber() {
            if (!currentCounter) return;

            const database = firebase.database();
            
            // Find next waiting number for this counter
            database.ref('queue/numbers').orderByChild('counter').equalTo(currentCounter).once('value', (snapshot) => {
                const numbers = snapshot.val() || {};
                const waitingNumbers = Object.entries(numbers)
                    .filter(([id, data]) => data.status === 'waiting')
                    .sort(([a], [b]) => {
                        const numA = parseInt(a.slice(1));
                        const numB = parseInt(b.slice(1));
                        return numA - numB;
                    });

                if (waitingNumbers.length === 0) {
                    alert('No customers in queue for this counter');
                    return;
                }

                const [nextNumberId, nextNumberData] = waitingNumbers[0];
                
                // Update Firebase
                const updates = {};
                updates[`queue/currentServing_${currentCounter}`] = nextNumberId;
                updates[`queue/numbers/${nextNumberId}/status`] = 'serving';
                
                database.ref().update(updates).then(() => {
                    // Play sound and announcement
                    playCallSound(nextNumberId, currentCounter);
                    
                    // Visual feedback
                    const servingElement = document.getElementById('nowServing');
                    servingElement.classList.add('call-animation');
                    setTimeout(() => {
                        servingElement.classList.remove('call-animation');
                    }, 500);
                    
                    console.log(`üì¢ Called number: ${nextNumberId} for Counter ${currentCounter}`);
                }).catch(error => {
                    console.error('‚ùå Error calling next:', error);
                    alert('Failed to call next number');
                });
            });
        }

        function playCallSound(number, counter) {
            if (callSound) {
                callSound.play();
            }
            
            // Speech announcement
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(`Number ${number}, please proceed to Counter ${counter}`);
                utterance.volume = 0.7;
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        function resetQueue() {
            if (!currentCounter) return;

            if (!confirm(`Are you sure you want to reset Queue ${currentCounter}? This will clear all queue data for this counter.`)) {
                return;
            }

            const database = firebase.database();
            const updates = {};
            
            // Reset counter data
            updates[`queue/lastNumber_${currentCounter}`] = 0;
            updates[`queue/currentServing_${currentCounter}`] = null;
            
            // Remove all numbers for this counter
            database.ref('queue/numbers').orderByChild('counter').equalTo(currentCounter).once('value', (snapshot) => {
                const numbers = snapshot.val() || {};
                Object.keys(numbers).forEach(numberId => {
                    updates[`queue/numbers/${numberId}`] = null;
                });
                
                database.ref().update(updates).then(() => {
                    console.log(`üîÑ Reset counter: ${currentCounter}`);
                    alert('Queue reset successfully');
                }).catch(error => {
                    console.error('‚ùå Error resetting queue:', error);
                    alert('Failed to reset queue');
                });
            });
        }

        // Settings Functions
        function loadCounterSettings() {
            if (!currentCounter) return;

            const database = firebase.database();
            database.ref(`settings/counter_${currentCounter}`).once('value', (snapshot) => {
                const settings = snapshot.val() || { prefix: currentCounter, sequenceType: 'sequential' };
                
                document.getElementById('prefixSelect').value = settings.prefix || currentCounter;
                document.getElementById('sequenceType').value = settings.sequenceType || 'sequential';
            });
        }

        function saveCounterSettings() {
            if (!currentCounter) return;

            const prefix = document.getElementById('prefixSelect').value;
            const sequenceType = document.getElementById('sequenceType').value;
            
            const database = firebase.database();
            const updates = {};
            updates[`settings/counter_${currentCounter}/prefix`] = prefix;
            updates[`settings/counter_${currentCounter}/sequenceType`] = sequenceType;
            
            database.ref().update(updates).then(() => {
                console.log('‚öôÔ∏è Settings saved');
            }).catch(error => {
                console.error('‚ùå Error saving settings:', error);
            });
        }

        // UI Updates
        function updateUI(queueData) {
            if (!currentCounter) return;

            const currentServing = queueData[`currentServing_${currentCounter}`] || '--';
            const lastNumber = queueData[`lastNumber_${currentCounter}`] || 0;
            
            document.getElementById('nowServing').textContent = currentServing;
            document.getElementById('lastIssued').textContent = lastNumber > 0 ? `${currentCounter}${lastNumber.toString().padStart(3, '0')}` : '--';
            
            // Count waiting numbers for this counter
            const numbers = queueData.numbers || {};
            const waitingCount = Object.values(numbers).filter(n => n.counter === currentCounter && n.status === 'waiting').length;
            document.getElementById('queueLength').textContent = waitingCount;
        }

        function checkQueueStatus(queueData) {
            const numbers = queueData.numbers || {};
            const hasActiveQueue = Object.values(numbers).some(n => n.status === 'waiting');
            
            const warningBanner = document.getElementById('warningBanner');
            const prefixSelect = document.getElementById('prefixSelect');
            const sequenceType = document.getElementById('sequenceType');
            
            if (hasActiveQueue) {
                warningBanner.classList.remove('hidden');
                if (currentCounter) {
                    const hasCounterQueue = Object.values(numbers).some(n => n.counter === currentCounter && n.status === 'waiting');
                    if (hasCounterQueue) {
                        prefixSelect.disabled = true;
                        sequenceType.disabled = true;
                    }
                }
            } else {
                warningBanner.classList.add('hidden');
                if (currentCounter) {
                    prefixSelect.disabled = false;
                    sequenceType.disabled = false;
                }
            }
        }

        function enableCounterControls() {
            document.getElementById('callNextBtn').disabled = false;
            document.getElementById('resetQueueBtn').disabled = false;
            document.getElementById('prefixSelect').disabled = false;
            document.getElementById('sequenceType').disabled = false;
        }

        function disableCounterControls() {
            document.getElementById('callNextBtn').disabled = true;
            document.getElementById('resetQueueBtn').disabled = true;
            document.getElementById('prefixSelect').disabled = true;
            document.getElementById('sequenceType').disabled = true;
        }

        // Cleanup
        window.addEventListener('beforeunload', function() {
            firebaseListeners.forEach(listener => {
                if (listener.ref && listener.ref.off) {
                    listener.ref.off(listener.type);
                }
            });
        });
    </script>
</body>
</html>
