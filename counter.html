
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter - Queue Joy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .slide-up { animation: slideUp 0.6s ease-out; }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .call-animation { animation: callPulse 0.5s ease-in-out; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes callPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .ad-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 8px;
            text-align: center;
            z-index: 40;
        }
        .ad-banner img {
            max-height: 60px;
            max-width: 100%;
            object-fit: contain;
        }
        .content-with-ad {
            padding-bottom: 80px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 content-with-ad">
    <!-- Hamburger Menu -->
    <div class="fixed top-4 left-4 z-50">
        <button id="hamburgerBtn" class="p-3 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg hover:bg-white transition-all duration-200">
            <div class="w-6 h-6 flex flex-col justify-center space-y-1">
                <span class="block w-full h-0.5 bg-gray-600 transform transition-transform"></span>
                <span class="block w-full h-0.5 bg-gray-600 transform transition-transform"></span>
                <span class="block w-full h-0.5 bg-gray-600 transform transition-transform"></span>
            </div>
        </button>
    </div>

    <!-- Navigation Menu -->
    <div id="navMenu" class="fixed inset-0 bg-black/50 z-40 hidden">
        <div class="fixed left-0 top-0 h-full w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300" id="navPanel">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Queue Joy</h2>
                <nav class="space-y-3">
                    <a href="./index.html" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-colors font-medium">
                        üè† Home
                    </a>
                    <a href="./counter.html" class="block px-4 py-3 bg-indigo-100 text-indigo-600 rounded-xl font-medium">
                        üéØ Counter
                    </a>
                </nav>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 slide-up">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">üîê Staff Login</h2>
            <p class="text-gray-600 text-center mb-6">Enter PIN to access counter</p>
            <input id="pinInput" type="password" maxlength="4" placeholder="0000" class="w-full p-4 text-center text-2xl border-2 border-gray-300 rounded-xl mb-4 focus:border-indigo-500 focus:outline-none">
            <div id="pinError" class="text-red-500 text-center mb-4 hidden">‚ùå Incorrect PIN. Try again.</div>
            <button id="pinSubmit" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-bold rounded-xl hover:scale-105 transition-all">Enter</button>
        </div>
    </div>

    <!-- Counter Setup Modal -->
    <div id="setupModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 slide-up">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">‚öôÔ∏è Counter Setup</h2>
            <p class="text-gray-600 text-center mb-6">Configure your counter</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Counter Number</label>
                <select id="counterSelect" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none">
                    <option value="">Choose Counter...</option>
                    <option value="counter1">Counter 1</option>
                    <option value="counter2">Counter 2</option>
                    <option value="counter3">Counter 3</option>
                    <option value="counter4">Counter 4</option>
                    <option value="counter5">Counter 5</option>
                    <option value="counter6">Counter 6</option>
                    <option value="counter7">Counter 7</option>
                    <option value="counter8">Counter 8</option>
                    <option value="counter9">Counter 9</option>
                    <option value="counter10">Counter 10</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Enter Prefix (A-Z only)</label>
                <input id="prefixInput" type="text" maxlength="5" placeholder="ABC" class="w-full p-3 text-center text-lg border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none uppercase">
                <div id="prefixError" class="text-red-500 text-sm mt-1 hidden">Only uppercase letters allowed</div>
            </div>

            <button id="setupSubmit" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-bold rounded-xl hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Setup Counter
            </button>
        </div>
    </div>

    <!-- Main Counter Panel -->
    <div id="counterPanel" class="min-h-screen flex flex-col justify-center items-center px-4 py-8 max-w-sm mx-auto text-center bg-white rounded-xl shadow-md gap-4 hidden">
        
        <!-- Header -->
        <div class="w-full mb-2">
            <h1 class="text-2xl font-bold text-gray-800" id="counterTitle">Counter Management</h1>
            <p class="text-gray-600">Queue Joy System</p>
        </div>

        <!-- Now Serving Display -->
        <div class="w-full bg-indigo-50 rounded-2xl p-6 mb-4">
            <p class="text-sm text-gray-600 mb-2">Now Serving</p>
            <p id="nowServing" class="text-4xl font-bold text-indigo-600">--</p>
        </div>

        <!-- Quick Stats -->
        <div class="w-full grid grid-cols-3 gap-3 mb-4">
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-xs text-gray-600">Prefix</p>
                <p id="queuePrefix" class="text-lg font-bold text-gray-800">-</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-xs text-gray-600">Last Called</p>
                <p id="lastCalled" class="text-lg font-bold text-gray-800">--</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-xs text-gray-600">In Queue</p>
                <p id="peopleInQueue" class="text-lg font-bold text-gray-800">0</p>
            </div>
        </div>

        <!-- Main Action Buttons -->
        <button id="callNextBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-500 text-white text-xl font-bold rounded-xl hover:scale-105 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            ‚ñ∂Ô∏è Call Next
        </button>

        <button id="recallBtn" class="w-full py-3 bg-yellow-500 text-white text-lg font-semibold rounded-xl hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            üîÅ Recall Last
        </button>

        <!-- Skip to Number -->
        <div class="w-full mt-4">
            <input id="skipInput" class="w-full text-center border-2 border-gray-300 rounded-xl p-3 mb-2 text-lg focus:border-indigo-500 focus:outline-none" placeholder="Skip to number (e.g. ABC110)">
            <button id="skipBtn" class="w-full py-3 bg-red-500 text-white font-semibold rounded-xl hover:scale-105 transition-all">
                ‚è© Skip to Number
            </button>
        </div>

        <!-- Ad Banner Management -->
        <div class="w-full mt-6 p-4 bg-gray-50 rounded-xl">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">üì¢ Update Ad Banner</h3>
            <input id="adUrlInput" type="url" placeholder="https://example.com/banner.png" class="w-full p-2 border border-gray-300 rounded-lg mb-2 text-sm focus:border-indigo-500 focus:outline-none">
            <button id="updateAdBtn" class="w-full py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors">
                Update Banner
            </button>
        </div>

        <!-- Action Status -->
        <p id="actionStatus" class="text-sm text-gray-500 min-h-[20px]"></p>

    </div>

    <!-- Ad Banner -->
    <div id="adBanner" class="ad-banner hidden">
        <img id="adImage" src="" alt="Advertisement" />
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="./js/firebase-config.js"></script>
    
    <script>
        let callSound = null;
        let currentCounterId = null;
        let counterConfig = null;
        let firebaseListeners = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Counter system initializing...');
            initializeAuth();
            initializeAudio();
            setupNavigation();
        });

        // Navigation setup
        function setupNavigation() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const navMenu = document.getElementById('navMenu');
            const navPanel = document.getElementById('navPanel');

            hamburgerBtn.addEventListener('click', function() {
                navMenu.classList.remove('hidden');
                setTimeout(() => {
                    navPanel.style.transform = 'translateX(0)';
                }, 10);
            });

            navMenu.addEventListener('click', function(e) {
                if (e.target === navMenu) {
                    navPanel.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        navMenu.classList.add('hidden');
                    }, 300);
                }
            });
        }

        // Authentication system
        function initializeAuth() {
            const pinModal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const pinSubmit = document.getElementById('pinSubmit');
            const pinError = document.getElementById('pinError');

            // Check if already authenticated
            if (sessionStorage.getItem('counterAuth') === 'true') {
                pinModal.classList.add('hidden');
                checkCounterSetup();
                return;
            }

            // PIN submission handlers
            pinSubmit.addEventListener('click', handlePinSubmit);
            pinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handlePinSubmit();
                pinError.classList.add('hidden');
            });

            function handlePinSubmit() {
                const pin = pinInput.value.trim();
                if (pin === '0108') {
                    sessionStorage.setItem('counterAuth', 'true');
                    pinModal.style.opacity = '0';
                    setTimeout(() => {
                        pinModal.classList.add('hidden');
                        checkCounterSetup();
                    }, 300);
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            }
        }

        // Check if counter is already set up
        function checkCounterSetup() {
            const savedCounter = sessionStorage.getItem('currentCounterId');
            const savedConfig = sessionStorage.getItem('counterConfig');
            
            if (savedCounter && savedConfig) {
                currentCounterId = savedCounter;
                counterConfig = JSON.parse(savedConfig);
                showCounterPanel();
            } else {
                showSetupModal();
            }
        }

        // Show setup modal
        function showSetupModal() {
            const setupModal = document.getElementById('setupModal');
            const counterSelect = document.getElementById('counterSelect');
            const prefixInput = document.getElementById('prefixInput');
            const setupSubmit = document.getElementById('setupSubmit');
            const prefixError = document.getElementById('prefixError');

            setupModal.classList.remove('hidden');

            // Validation
            function validateForm() {
                const counter = counterSelect.value;
                const prefix = prefixInput.value.trim();
                const isValidPrefix = /^[A-Z]+$/.test(prefix);
                
                if (!isValidPrefix && prefix.length > 0) {
                    prefixError.classList.remove('hidden');
                } else {
                    prefixError.classList.add('hidden');
                }

                setupSubmit.disabled = !(counter && prefix && isValidPrefix);
            }

            counterSelect.addEventListener('change', validateForm);
            prefixInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                validateForm();
            });

            setupSubmit.addEventListener('click', function() {
                const counter = counterSelect.value;
                const prefix = prefixInput.value.trim();

                if (counter && prefix && /^[A-Z]+$/.test(prefix)) {
                    currentCounterId = counter;
                    counterConfig = {
                        prefix: prefix,
                        current: 0,
                        lastSuffix: 0
                    };

                    // Save to Firebase and session
                    saveCounterConfig().then(() => {
                        sessionStorage.setItem('currentCounterId', currentCounterId);
                        sessionStorage.setItem('counterConfig', JSON.stringify(counterConfig));
                        
                        setupModal.classList.add('hidden');
                        showCounterPanel();
                    });
                }
            });
        }

        // Save counter configuration to Firebase
        function saveCounterConfig() {
            const database = firebase.database();
            return database.ref(`settings/counters/${currentCounterId}`).set(counterConfig);
        }

        // Show counter panel
        function showCounterPanel() {
            const counterPanel = document.getElementById('counterPanel');
            const counterTitle = document.getElementById('counterTitle');
            const queuePrefix = document.getElementById('queuePrefix');

            counterTitle.textContent = `${currentCounterId.charAt(0).toUpperCase() + currentCounterId.slice(1)} Management`;
            queuePrefix.textContent = counterConfig.prefix;

            counterPanel.classList.remove('hidden');
            
            setTimeout(() => {
                initializeFirebase();
                setupEventListeners();
                loadCounterData();
            }, 500);
        }

        // Audio system
        function initializeAudio() {
            try {
                callSound = new Howl({
                    src: ['data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'],
                    volume: 0.7
                });
            } catch (error) {
                console.warn('‚ö†Ô∏è Audio initialization failed');
            }
        }

        // Firebase initialization
        function initializeFirebase() {
            if (typeof firebase === 'undefined' || !firebase.database) {
                console.error('‚ùå Firebase not available');
                showStatus('‚ùå System error - please refresh', 'error');
                return;
            }

            loadAdBanner();
        }

        // Load ad banner
        function loadAdBanner() {
            const database = firebase.database();
            const adBannerRef = database.ref('settings/adBanner');
            
            adBannerRef.on('value', (snapshot) => {
                const adUrl = snapshot.val();
                const adBanner = document.getElementById('adBanner');
                const adImage = document.getElementById('adImage');
                const adUrlInput = document.getElementById('adUrlInput');
                
                if (adUrl && adUrl.trim()) {
                    adImage.src = adUrl;
                    adBanner.classList.remove('hidden');
                    adUrlInput.value = adUrl;
                } else {
                    adBanner.classList.add('hidden');
                }
            });
            firebaseListeners.push(adBannerRef);
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('callNextBtn').addEventListener('click', callNextNumber);
            document.getElementById('recallBtn').addEventListener('click', recallLastNumber);
            document.getElementById('skipBtn').addEventListener('click', skipToNumber);
            document.getElementById('updateAdBtn').addEventListener('click', updateAdBanner);
        }

        // Load counter data
        function loadCounterData() {
            const database = firebase.database();
            
            // Load counter config from Firebase
            const counterRef = database.ref(`settings/counters/${currentCounterId}`);
            counterRef.on('value', (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    counterConfig = config;
                    updateDisplay();
                    enableButtons();
                }
            });
            firebaseListeners.push(counterRef);

            // Load queue data
            updateQueueStats();
        }

        // Update display
        function updateDisplay() {
            const nowServing = document.getElementById('nowServing');
            const lastCalled = document.getElementById('lastCalled');
            
            if (counterConfig.current > 0) {
                const currentNumber = `${counterConfig.prefix}${counterConfig.current.toString().padStart(3, '0')}`;
                nowServing.textContent = currentNumber;
                lastCalled.textContent = currentNumber;
            } else {
                nowServing.textContent = '--';
                lastCalled.textContent = '--';
            }
        }

        // Enable buttons
        function enableButtons() {
            document.getElementById('callNextBtn').disabled = false;
            document.getElementById('recallBtn').disabled = counterConfig.current === 0;
        }

        // Update queue statistics
        function updateQueueStats() {
            const database = firebase.database();
            const today = new Date().toISOString().split('T')[0];
            
            database.ref(`queues/${today}/${currentCounterId}`).once('value', (snapshot) => {
                const queue = snapshot.val() || {};
                const waitingCount = Object.values(queue).filter(item => item.status === 'waiting').length;
                document.getElementById('peopleInQueue').textContent = waitingCount;
            });
        }

        // Call next number
        function callNextNumber() {
            const database = firebase.database();
            const today = new Date().toISOString().split('T')[0];
            
            // Find next waiting number
            database.ref(`queues/${today}/${currentCounterId}`).orderByChild('status').equalTo('waiting').limitToFirst(1).once('value', (snapshot) => {
                const queue = snapshot.val();
                
                if (queue && Object.keys(queue).length > 0) {
                    // Call the next waiting number
                    const nextQueueId = Object.keys(queue)[0];
                    const nextQueueData = queue[nextQueueId];
                    
                    // Update counter and queue status
                    const updates = {};
                    updates[`settings/counters/${currentCounterId}/current`] = parseInt(nextQueueData.number.replace(counterConfig.prefix, ''));
                    updates[`queues/${today}/${currentCounterId}/${nextQueueId}/status`] = 'serving';
                    updates[`queues/${today}/${currentCounterId}/${nextQueueId}/calledAt`] = Date.now();
                    
                    database.ref().update(updates).then(() => {
                        playCallSound();
                        showStatus(`‚úÖ Called ${nextQueueData.number}`, 'success');
                        
                        // Visual feedback
                        const servingElement = document.getElementById('nowServing');
                        servingElement.classList.add('call-animation');
                        setTimeout(() => servingElement.classList.remove('call-animation'), 500);
                        
                        updateQueueStats();
                    });
                } else {
                    showStatus('No customers in queue', 'warning');
                }
            });
        }

        // Recall last number
        function recallLastNumber() {
            const serving = document.getElementById('nowServing').textContent;
            if (serving === '--') {
                showStatus('No number to recall', 'warning');
                return;
            }
            
            playCallSound();
            showStatus(`üîÅ Recalled ${serving}`, 'success');
            
            const servingElement = document.getElementById('nowServing');
            servingElement.classList.add('call-animation');
            setTimeout(() => servingElement.classList.remove('call-animation'), 500);
        }

        // Skip to number
        function skipToNumber() {
            const skipInput = document.getElementById('skipInput');
            const number = skipInput.value.trim().toUpperCase();
            
            if (!number || !number.startsWith(counterConfig.prefix)) {
                showStatus(`‚ùå Invalid format. Use ${counterConfig.prefix}001, ${counterConfig.prefix}002, etc.`, 'error');
                return;
            }

            const suffix = parseInt(number.replace(counterConfig.prefix, ''));
            if (isNaN(suffix) || suffix < 1) {
                showStatus('‚ùå Invalid number', 'error');
                return;
            }

            const database = firebase.database();
            database.ref(`settings/counters/${currentCounterId}/current`).set(suffix).then(() => {
                playCallSound();
                showStatus(`‚è© Skipped to ${number}`, 'success');
                skipInput.value = '';
            }).catch(() => {
                showStatus('‚ùå Failed to skip to number', 'error');
            });
        }

        // Update ad banner
        function updateAdBanner() {
            const adUrl = document.getElementById('adUrlInput').value.trim();
            
            if (adUrl && !adUrl.toLowerCase().includes('.png')) {
                showStatus('‚ùå Please use PNG images only', 'error');
                return;
            }

            const database = firebase.database();
            if (adUrl === '') {
                database.ref('settings/adBanner').remove().then(() => {
                    showStatus('‚úÖ Ad banner removed', 'success');
                });
            } else {
                database.ref('settings/adBanner').set(adUrl).then(() => {
                    showStatus('‚úÖ Ad banner updated', 'success');
                }).catch(() => {
                    showStatus('‚ùå Failed to update banner', 'error');
                });
            }
        }

        // Play call sound
        function playCallSound() {
            if (callSound) {
                callSound.play();
            }
            
            if ('speechSynthesis' in window) {
                const serving = document.getElementById('nowServing').textContent;
                const counterName = currentCounterId.replace('counter', 'Counter ');
                const utterance = new SpeechSynthesisUtterance(`Number ${serving}, please proceed to ${counterName}`);
                utterance.volume = 0.7;
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('actionStatus');
            statusElement.textContent = message;
            statusElement.className = `text-sm min-h-[20px] ${
                type === 'success' ? 'text-green-600' :
                type === 'error' ? 'text-red-600' :
                type === 'warning' ? 'text-yellow-600' :
                'text-gray-500'
            }`;
            
            // Clear after 3 seconds
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'text-sm text-gray-500 min-h-[20px]';
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            firebaseListeners.forEach(ref => {
                if (ref && ref.off) ref.off();
            });
        });
    </script>
</body>
</html>
