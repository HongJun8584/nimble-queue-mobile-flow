
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter Management - Queue Joy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .slide-up { animation: slideUp 0.6s ease-out; }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .call-animation { animation: callPulse 0.5s ease-in-out; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes callPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-warning {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 slide-up">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">üîê Staff Login</h2>
            <p class="text-gray-600 text-center mb-6">Enter PIN to access counter panel</p>
            <input id="pinInput" type="password" maxlength="4" placeholder="0000" class="w-full p-4 text-center text-2xl border-2 border-gray-300 rounded-xl mb-4 focus:border-purple-500 focus:outline-none">
            <div id="pinError" class="text-red-500 text-center mb-4 hidden">‚ùå Incorrect PIN. Please try again.</div>
            <button id="pinSubmit" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-xl hover:shadow-lg transition-all">Enter</button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="counterPanel" class="container mx-auto px-4 py-8 hidden">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <div class="flex justify-between items-center mb-4">
                <a href="./index.html" class="text-white/80 hover:text-white transition-colors">‚Üê Back to Home</a>
                <button id="logoutBtn" class="text-white/80 hover:text-white transition-colors">Logout</button>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">üéØ Counter Management</h1>
            <p class="text-white/80">Staff Control Panel</p>
        </div>

        <!-- Warning Banner -->
        <div id="warningBanner" class="bg-red-500 text-white p-4 rounded-2xl mb-6 text-center font-bold pulse-warning hidden">
            ‚ö†Ô∏è Active customers in queue - settings changes restricted
        </div>

        <!-- Counter Management -->
        <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 mb-6 slide-up">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Active Counters</h2>
            <div class="flex flex-wrap gap-2 mb-4">
                <div id="counterTags" class="flex flex-wrap gap-2">
                    <!-- Counter tags will be populated here -->
                </div>
            </div>
            <div class="flex gap-2">
                <select id="addCounterSelect" class="flex-1 p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none">
                    <option value="">Add Counter...</option>
                    <option value="A">Counter A</option>
                    <option value="B">Counter B</option>
                    <option value="C">Counter C</option>
                    <option value="D">Counter D</option>
                    <option value="E">Counter E</option>
                    <option value="F">Counter F</option>
                </select>
                <button id="addCounterBtn" class="px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors">Add</button>
            </div>
        </div>

        <!-- Counter Selection -->
        <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 mb-6 slide-up">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Select Counter to Manage</h2>
            <select id="counterSelect" class="w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none">
                <option value="">-- Choose Counter --</option>
            </select>
        </div>

        <!-- Counter Control Panel -->
        <div id="controlPanel" class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 slide-up hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">üìä Queue Control</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <div class="text-sm text-gray-600 font-medium">Now Serving</div>
                    <div id="nowServing" class="text-3xl font-bold text-green-600 mt-1">--</div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-xl">
                    <div class="text-sm text-gray-600 font-medium">Last Issued</div>
                    <div id="lastIssued" class="text-2xl font-bold text-blue-600 mt-1">--</div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="space-y-3">
                <button id="callNextBtn" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    üì¢ Call Next Number
                </button>
                
                <button id="resetQueueBtn" class="w-full py-4 bg-gradient-to-r from-red-500 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    üîÑ Reset Queue
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Howler.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <!-- Firebase Config -->
    <script src="./js/firebase-config.js"></script>
    
    <script>
        let currentCounter = null;
        let callSound = null;
        let firebaseListeners = [];
        let activeCounters = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Counter system initializing...');
            initializeAuth();
            initializeAudio();
        });

        // Authentication system - Fixed PIN login
        function initializeAuth() {
            const pinModal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const pinSubmit = document.getElementById('pinSubmit');
            const pinError = document.getElementById('pinError');
            const counterPanel = document.getElementById('counterPanel');
            const logoutBtn = document.getElementById('logoutBtn');

            // Check if already authenticated
            if (sessionStorage.getItem('counterAuth') === 'true') {
                showCounterPanel();
                return;
            }

            // PIN submission handlers
            pinSubmit.addEventListener('click', handlePinSubmit);
            pinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handlePinSubmit();
                // Clear error on typing
                pinError.classList.add('hidden');
            });

            // Logout handler
            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('counterAuth');
                location.reload();
            });

            function handlePinSubmit() {
                const pin = pinInput.value.trim();
                if (pin === '0108') {
                    sessionStorage.setItem('counterAuth', 'true');
                    pinModal.style.opacity = '0';
                    setTimeout(() => {
                        pinModal.classList.add('hidden');
                        showCounterPanel();
                    }, 300);
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                    // Add shake animation
                    pinInput.style.animation = 'shake 0.5s';
                    setTimeout(() => pinInput.style.animation = '', 500);
                }
            }

            function showCounterPanel() {
                counterPanel.classList.remove('hidden');
                setTimeout(initializeFirebase, 500);
            }
        }

        // Audio system initialization
        function initializeAudio() {
            try {
                callSound = new Howl({
                    src: ['data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT'],
                    volume: 0.7
                });
            } catch (error) {
                console.warn('‚ö†Ô∏è Audio initialization failed');
            }
        }

        // Firebase initialization with real-time listeners
        function initializeFirebase() {
            if (typeof firebase === 'undefined' || !firebase.database) {
                console.error('‚ùå Firebase not available');
                return;
            }

            const database = firebase.database();
            
            // Load active counters with real-time sync
            loadActiveCounters();
            setupEventListeners();
        }

        // Load and manage active counters with real-time updates
        function loadActiveCounters() {
            const database = firebase.database();
            const activeCountersRef = database.ref('settings/activeCounters');
            
            activeCountersRef.on('value', (snapshot) => {
                activeCounters = snapshot.val() || [];
                console.log('üì° Active counters updated:', activeCounters);
                updateCounterTags();
                updateCounterSelect();
                checkQueueStatus();
            });
            firebaseListeners.push(activeCountersRef);
        }

        // Update counter display tags
        function updateCounterTags() {
            const counterTags = document.getElementById('counterTags');
            counterTags.innerHTML = '';
            
            if (activeCounters.length === 0) {
                counterTags.innerHTML = '<div class="text-gray-500 italic">No active counters</div>';
                return;
            }
            
            activeCounters.forEach(counter => {
                const tag = document.createElement('div');
                tag.className = 'bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm flex items-center gap-2 font-medium';
                tag.innerHTML = `
                    Counter ${counter}
                    <button onclick="removeCounter('${counter}')" class="text-red-500 hover:text-red-700 ml-1 font-bold">√ó</button>
                `;
                counterTags.appendChild(tag);
            });
        }

        // Update counter selection dropdown
        function updateCounterSelect() {
            const counterSelect = document.getElementById('counterSelect');
            const addCounterSelect = document.getElementById('addCounterSelect');
            
            // Update main counter select
            counterSelect.innerHTML = '<option value="">-- Choose Counter --</option>';
            activeCounters.forEach(counter => {
                const option = document.createElement('option');
                option.value = counter;
                option.textContent = `Counter ${counter}`;
                counterSelect.appendChild(option);
            });
            
            // Update add counter select (show only inactive counters)
            const allCounters = ['A', 'B', 'C', 'D', 'E', 'F'];
            addCounterSelect.innerHTML = '<option value="">Add Counter...</option>';
            allCounters.forEach(counter => {
                if (!activeCounters.includes(counter)) {
                    const option = document.createElement('option');
                    option.value = counter;
                    option.textContent = `Counter ${counter}`;
                    addCounterSelect.appendChild(option);
                }
            });
        }

        // Counter management functions
        window.removeCounter = function(counter) {
            if (activeCounters.length <= 1) {
                alert('‚ö†Ô∏è Cannot remove the last active counter');
                return;
            }
            
            if (confirm(`Remove Counter ${counter}? This will disable it from the system.`)) {
                const newCounters = activeCounters.filter(c => c !== counter);
                firebase.database().ref('settings/activeCounters').set(newCounters);
            }
        };

        // Event listeners setup
        function setupEventListeners() {
            // Counter selection handler
            const counterSelect = document.getElementById('counterSelect');
            counterSelect.addEventListener('change', function() {
                currentCounter = this.value;
                if (currentCounter) {
                    showControlPanel();
                    startCounterMonitoring();
                } else {
                    hideControlPanel();
                    stopCounterMonitoring();
                }
            });

            // Add counter functionality
            const addCounterBtn = document.getElementById('addCounterBtn');
            const addCounterSelect = document.getElementById('addCounterSelect');
            
            addCounterBtn.addEventListener('click', function() {
                const newCounter = addCounterSelect.value;
                if (newCounter && activeCounters.length < 6) {
                    const updatedCounters = [...activeCounters, newCounter].sort();
                    firebase.database().ref('settings/activeCounters').set(updatedCounters);
                    addCounterSelect.value = '';
                }
            });

            // Control buttons
            document.getElementById('callNextBtn').addEventListener('click', callNextNumber);
            document.getElementById('resetQueueBtn').addEventListener('click', resetQueue);
        }

        // Show/hide control panel
        function showControlPanel() {
            document.getElementById('controlPanel').classList.remove('hidden');
            document.getElementById('callNextBtn').disabled = false;
            document.getElementById('resetQueueBtn').disabled = false;
        }

        function hideControlPanel() {
            document.getElementById('controlPanel').classList.add('hidden');
        }

        // Counter monitoring with real-time updates
        let counterMonitoringRefs = [];

        function startCounterMonitoring() {
            if (!currentCounter) return;

            stopCounterMonitoring();
            const database = firebase.database();
            
            // Monitor current serving
            const currentServingRef = database.ref(`queue/currentServing_${currentCounter}`);
            currentServingRef.on('value', (snapshot) => {
                const serving = snapshot.val() || '--';
                document.getElementById('nowServing').textContent = serving;
            });
            counterMonitoringRefs.push(currentServingRef);
            
            // Monitor last number issued
            const lastNumberRef = database.ref(`queue/lastNumber_${currentCounter}`);
            lastNumberRef.on('value', (snapshot) => {
                const lastNum = snapshot.val() || 0;
                const formatted = lastNum > 0 ? `${currentCounter}${lastNum.toString().padStart(3, '0')}` : '--';
                document.getElementById('lastIssued').textContent = formatted;
            });
            counterMonitoringRefs.push(lastNumberRef);
        }

        function stopCounterMonitoring() {
            counterMonitoringRefs.forEach(ref => {
                if (ref && ref.off) ref.off();
            });
            counterMonitoringRefs = [];
        }

        // Call next number function
        function callNextNumber() {
            if (!currentCounter) return;

            const database = firebase.database();
            
            // Find next waiting number for this counter
            database.ref('queue/numbers').orderByChild('counter').equalTo(currentCounter).once('value', (snapshot) => {
                const numbers = snapshot.val() || {};
                const waitingNumbers = Object.entries(numbers)
                    .filter(([id, data]) => data.status === 'waiting')
                    .sort(([a, aData], [b, bData]) => aData.timestamp - bData.timestamp);

                if (waitingNumbers.length === 0) {
                    alert('No customers in queue for this counter');
                    return;
                }

                const [nextNumberId, nextNumberData] = waitingNumbers[0];
                
                // Update Firebase atomically
                const updates = {};
                updates[`queue/currentServing_${currentCounter}`] = nextNumberData.number;
                updates[`queue/numbers/${nextNumberId}/status`] = 'serving';
                
                database.ref().update(updates).then(() => {
                    // Play sound and announcement
                    playCallSound(nextNumberData.number, currentCounter);
                    
                    // Visual feedback
                    const servingElement = document.getElementById('nowServing');
                    servingElement.classList.add('call-animation');
                    setTimeout(() => servingElement.classList.remove('call-animation'), 500);
                    
                    console.log(`üì¢ Called number: ${nextNumberData.number} for Counter ${currentCounter}`);
                }).catch(error => {
                    console.error('‚ùå Error calling next:', error);
                    alert('Failed to call next number');
                });
            });
        }

        // Play call sound with speech
        function playCallSound(number, counter) {
            if (callSound) {
                callSound.play();
            }
            
            // Speech announcement
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(`Number ${number}, please proceed to Counter ${counter}`);
                utterance.volume = 0.7;
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // Reset queue function
        function resetQueue() {
            if (!currentCounter) return;

            if (!confirm(`Are you sure you want to reset Queue ${currentCounter}? This will clear all queue data for this counter.`)) {
                return;
            }

            const database = firebase.database();
            const updates = {};
            
            // Reset counter data
            updates[`queue/lastNumber_${currentCounter}`] = 0;
            updates[`queue/currentServing_${currentCounter}`] = null;
            
            // Remove all numbers for this counter
            database.ref('queue/numbers').orderByChild('counter').equalTo(currentCounter).once('value', (snapshot) => {
                const numbers = snapshot.val() || {};
                Object.keys(numbers).forEach(numberId => {
                    updates[`queue/numbers/${numberId}`] = null;
                });
                
                database.ref().update(updates).then(() => {
                    console.log(`üîÑ Reset counter: ${currentCounter}`);
                    alert('Queue reset successfully');
                }).catch(error => {
                    console.error('‚ùå Error resetting queue:', error);
                    alert('Failed to reset queue');
                });
            });
        }

        // Check queue status for warnings
        function checkQueueStatus() {
            const database = firebase.database();
            database.ref('queue/numbers').once('value', (snapshot) => {
                const numbers = snapshot.val() || {};
                const hasActiveQueue = Object.values(numbers).some(n => n.status === 'waiting');
                
                const warningBanner = document.getElementById('warningBanner');
                if (hasActiveQueue) {
                    warningBanner.classList.remove('hidden');
                } else {
                    warningBanner.classList.add('hidden');
                }
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            firebaseListeners.forEach(ref => {
                if (ref && ref.off) ref.off();
            });
            counterMonitoringRefs.forEach(ref => {
                if (ref && ref.off) ref.off();
            });
        });
    </script>
</body>
</html>
