<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Joy - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { @apply bg-purple-600 text-white; }
        .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- PIN Login Screen -->
    <div id="pinScreen" class="min-h-screen flex flex-col justify-center items-center px-4 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">üîê Admin Access</h1>
            <p class="text-gray-600 mb-6">Enter PIN to access admin panel</p>
            
            <input type="password" id="pinInput" class="w-full border border-gray-300 p-3 rounded-lg text-center text-xl tracking-widest mb-4" placeholder="0000" maxlength="4">
            <p id="pinError" class="text-red-500 text-sm text-center mb-4 hidden">Incorrect PIN. Please try again.</p>
            
            <div class="space-y-2">
                <button id="pinSubmit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
                    Enter Admin Panel
                </button>
                <button id="pinCancel" class="w-full py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-all duration-300">
                    Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Hamburger Menu -->
    <div id="hamburgerMenu" class="fixed top-4 right-4 z-50 hidden">
        <button id="menuToggle" class="bg-white p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        
        <div id="menuPanel" class="absolute top-16 right-0 bg-white rounded-xl shadow-xl p-4 w-48 hidden">
            <a href="./index.html" class="block py-2 px-3 text-gray-700 hover:bg-purple-50 rounded-lg">üè† Home</a>
            <a href="./admin.html" class="block py-2 px-3 text-gray-700 hover:bg-purple-50 rounded-lg bg-purple-50">‚öôÔ∏è Admin</a>
            <a href="./counter.html" class="block py-2 px-3 text-gray-700 hover:bg-purple-50 rounded-lg">üéØ Counter</a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="min-h-screen px-4 py-8 hidden">
        <div class="max-w-md mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 text-center">
                <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Admin Panel</h1>
                <p class="text-gray-600 mt-2">Queue Management System</p>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <button id="queueTab" class="tab-active py-2 px-3 rounded-lg font-semibold transition-all duration-300 text-sm">Queue</button>
                    <button id="settingsTab" class="tab-inactive py-2 px-3 rounded-lg font-semibold transition-all duration-300 text-sm">Settings</button>
                    <button id="analyticsTab" class="tab-inactive py-2 px-3 rounded-lg font-semibold transition-all duration-300 text-sm">Analytics</button>
                </div>

                <!-- Queue Management Tab -->
                <div id="queueContent">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üéØ Queue Control</h3>
                    
                    <!-- Current Status -->
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-4 mb-4 border border-emerald-200">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-xs text-gray-600 font-medium">Now Serving</p>
                                <p id="adminCurrentServing" class="text-2xl font-bold text-emerald-600">A001</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-medium">Last Issued</p>
                                <p id="adminLastIssued" class="text-2xl font-bold text-blue-600">A001</p>
                            </div>
                        </div>
                    </div>

                    <!-- Queue Actions -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Set Now Serving:</label>
                            <div class="flex gap-2">
                                <input type="text" id="setServingInput" placeholder="A001" class="flex-1 border border-gray-300 p-2 rounded-lg text-center">
                                <button id="setServingBtn" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all">Set</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Jump to Number:</label>
                            <div class="flex gap-2">
                                <input type="text" id="jumpToInput" placeholder="A100" class="flex-1 border border-gray-300 p-2 rounded-lg text-center">
                                <button id="jumpToBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">Jump</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button id="pauseQueueBtn" class="py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all font-medium">
                                <span id="pauseQueueText">‚è∏Ô∏è Pause</span>
                            </button>
                            <button id="resetQueueBtn" class="py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium">üóëÔ∏è Reset</button>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsContent" class="hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">‚öôÔ∏è Queue Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Queue Prefix:</label>
                            <select id="queuePrefix" class="w-full border border-gray-300 p-3 rounded-lg">
                                <option value="A">A (General)</option>
                                <option value="B">B (Priority)</option>
                                <option value="C">C (Special)</option>
                                <option value="VIP">VIP (VIP Service)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Starting Number:</label>
                            <input type="number" id="startNumber" value="1" min="1" max="999" class="w-full border border-gray-300 p-3 rounded-lg">
                        </div>
                        <button id="saveSettingsBtn" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
                            üíæ Save Settings
                        </button>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div id="analyticsContent" class="hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Queue Analytics</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">Today Served</p>
                            <p id="todayServed" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">In Queue</p>
                            <p id="inQueue" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                    </div>

                    <!-- Active Numbers List -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold text-gray-700 mb-3">Active Queue Numbers:</h4>
                        <div id="activeNumbers" class="text-sm text-gray-600">
                            <p class="text-center py-2">No active numbers</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div class="text-center">
                <p id="statusMsg" class="text-sm text-green-600 hidden">‚úÖ Action completed!</p>
                <p id="errorMsg" class="text-sm text-red-500 hidden">‚ùå Error occurred!</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="./js/firebase-config.js"></script>
    
    <!-- Navigation Script -->
    <script src="./js/navigation.js"></script>
    
    <!-- Main Script -->
    <script>
        let queueSettings = { prefix: 'A', startNumber: 1, isPaused: false };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß Admin panel loaded');
            
            if (sessionStorage.getItem('adminAuth') === 'true') {
                showMainContent();
            } else {
                initializePinScreen();
            }
        });

        function initializePinScreen() {
            const pinInput = document.getElementById('pinInput');
            const pinSubmit = document.getElementById('pinSubmit');
            const pinCancel = document.getElementById('pinCancel');
            const pinError = document.getElementById('pinError');
            
            pinSubmit.addEventListener('click', () => {
                const pin = pinInput.value;
                if (pin === '0108') {
                    sessionStorage.setItem('adminAuth', 'true');
                    showMainContent();
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            });
            
            pinCancel.addEventListener('click', () => {
                window.location.href = './index.html';
            });
            
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    pinSubmit.click();
                }
            });
            
            pinInput.focus();
        }

        function showMainContent() {
            document.getElementById('pinScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('hamburgerMenu').classList.remove('hidden');
            
            initializeNavigation();
            loadQueueData();
            setupEventListeners();
            startLiveUpdates();
        }

        function setupEventListeners() {
            // Tab switching
            document.getElementById('queueTab').addEventListener('click', () => switchTab('queue'));
            document.getElementById('settingsTab').addEventListener('click', () => switchTab('settings'));
            document.getElementById('analyticsTab').addEventListener('click', () => switchTab('analytics'));
            
            // Queue actions
            document.getElementById('setServingBtn').addEventListener('click', setCurrentServing);
            document.getElementById('jumpToBtn').addEventListener('click', jumpToNumber);
            document.getElementById('pauseQueueBtn').addEventListener('click', togglePauseQueue);
            document.getElementById('resetQueueBtn').addEventListener('click', resetQueue);
            
            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        }

        function switchTab(tab) {
            const tabs = ['queue', 'settings', 'analytics'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById(t + 'Tab');
                const content = document.getElementById(t + 'Content');
                if (t === tab) {
                    tabBtn.className = 'tab-active py-2 px-3 rounded-lg font-semibold transition-all duration-300 text-sm';
                    content.classList.remove('hidden');
                } else {
                    tabBtn.className = 'tab-inactive py-2 px-3 rounded-lg font-semibold transition-all duration-300 text-sm';
                    content.classList.add('hidden');
                }
            });
            
            if (tab === 'analytics') {
                loadAnalytics();
            }
        }

        function loadQueueData() {
            firebase.database().ref('queue/settings').once('value', (snapshot) => {
                const settings = snapshot.val() || { prefix: 'A', startNumber: 1, isPaused: false };
                queueSettings = settings;
                
                document.getElementById('queuePrefix').value = settings.prefix;
                document.getElementById('startNumber').value = settings.startNumber;
                
                updatePauseButton();
            });
        }

        function startLiveUpdates() {
            firebase.database().ref('queue').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                
                document.getElementById('adminCurrentServing').textContent = data.currentServing || 'A001';
                document.getElementById('adminLastIssued').textContent = data.lastNumber ? 
                    (queueSettings.prefix + String(data.lastNumber).padStart(3, '0')) : 'A001';
            });
        }

        function setCurrentServing() {
            const input = document.getElementById('setServingInput');
            const newServing = input.value.trim().toUpperCase();
            
            if (!newServing.match(/^[A-Z]{1,3}\d{3}$/)) {
                showError('Invalid format. Use format like A001');
                return;
            }
            
            firebase.database().ref('queue/currentServing').set(newServing)
                .then(() => {
                    showStatus('Now serving updated to ' + newServing);
                    input.value = '';
                })
                .catch(error => showError('Failed to update: ' + error.message));
        }

        function jumpToNumber() {
            const input = document.getElementById('jumpToInput');
            const jumpTo = input.value.trim().toUpperCase();
            
            if (!jumpTo.match(/^[A-Z]{1,3}\d{3}$/)) {
                showError('Invalid format. Use format like A100');
                return;
            }
            
            const numberPart = parseInt(jumpTo.replace(/[A-Z]/g, ''));
            
            firebase.database().ref('queue/lastNumber').set(numberPart)
                .then(() => {
                    showStatus('Queue jumped to ' + jumpTo);
                    input.value = '';
                })
                .catch(error => showError('Failed to jump: ' + error.message));
        }

        function togglePauseQueue() {
            queueSettings.isPaused = !queueSettings.isPaused;
            
            firebase.database().ref('queue/settings/isPaused').set(queueSettings.isPaused)
                .then(() => {
                    updatePauseButton();
                    showStatus(queueSettings.isPaused ? 'Queue paused' : 'Queue resumed');
                })
                .catch(error => showError('Failed to toggle pause: ' + error.message));
        }

        function updatePauseButton() {
            const btn = document.getElementById('pauseQueueBtn');
            const text = document.getElementById('pauseQueueText');
            if (queueSettings.isPaused) {
                btn.className = 'py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium';
                text.textContent = '‚ñ∂Ô∏è Resume';
            } else {
                btn.className = 'py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all font-medium';
                text.textContent = '‚è∏Ô∏è Pause';
            }
        }

        function resetQueue() {
            if (!confirm('Are you sure you want to reset the entire queue? This cannot be undone.')) {
                return;
            }
            
            const resetData = {
                currentServing: queueSettings.prefix + '001',
                lastNumber: queueSettings.startNumber,
                numbers: {}
            };
            
            firebase.database().ref('queue').update(resetData)
                .then(() => {
                    showStatus('Queue reset successfully');
                    loadAnalytics();
                })
                .catch(error => showError('Failed to reset queue: ' + error.message));
        }

        function saveSettings() {
            const prefix = document.getElementById('queuePrefix').value;
            const startNumber = parseInt(document.getElementById('startNumber').value);
            
            queueSettings = { ...queueSettings, prefix, startNumber };
            
            firebase.database().ref('queue/settings').set(queueSettings)
                .then(() => {
                    showStatus('Settings saved successfully');
                })
                .catch(error => showError('Failed to save settings: ' + error.message));
        }

        function loadAnalytics() {
            firebase.database().ref('queue').once('value', (snapshot) => {
                const data = snapshot.val() || {};
                const currentNum = parseInt((data.currentServing || 'A001').replace(/[A-Z]/g, ''));
                const lastNum = data.lastNumber || 1;
                
                const served = Math.max(0, currentNum - queueSettings.startNumber);
                const inQueue = Math.max(0, lastNum - currentNum);
                
                document.getElementById('todayServed').textContent = served;
                document.getElementById('inQueue').textContent = inQueue;
                
                // Show active numbers
                const activeContainer = document.getElementById('activeNumbers');
                if (inQueue > 0) {
                    const activeNums = [];
                    for (let i = currentNum + 1; i <= lastNum; i++) {
                        activeNums.push(queueSettings.prefix + String(i).padStart(3, '0'));
                    }
                    activeContainer.innerHTML = activeNums.map(num => 
                        `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 mb-2">${num}</span>`
                    ).join('');
                } else {
                    activeContainer.innerHTML = '<p class="text-center py-2">No active numbers</p>';
                }
            });
        }

        function showStatus(message) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = '‚úÖ ' + message;
            statusMsg.classList.remove('hidden');
            setTimeout(() => statusMsg.classList.add('hidden'), 3000);
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = '‚ùå ' + message;
            errorMsg.classList.remove('hidden');
            setTimeout(() => errorMsg.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
