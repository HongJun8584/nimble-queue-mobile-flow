<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Joy - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { @apply bg-purple-600 text-white; }
        .tab-inactive { @apply bg-gray-200 text-gray-600 hover:bg-gray-300; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- PIN Login Screen -->
    <div id="pinScreen" class="min-h-screen flex flex-col justify-center items-center px-4 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ” Admin Access</h1>
            <p class="text-gray-600 mb-6">Enter PIN to access admin panel</p>
            
            <input type="password" id="pinInput" class="w-full border border-gray-300 p-3 rounded-lg text-center text-xl tracking-widest mb-4" placeholder="0000" maxlength="4">
            <p id="pinError" class="text-red-500 text-sm text-center mb-4 hidden">Incorrect PIN. Please try again.</p>
            
            <div class="space-y-2">
                <button id="pinSubmit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
                    Enter Admin Panel
                </button>
                <button id="pinCancel" class="w-full py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-all duration-300">
                    Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Hamburger Menu -->
    <div id="hamburgerMenu" class="fixed top-4 right-4 z-50 hidden">
        <button id="menuToggle" class="bg-white p-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        
        <div id="menuPanel" class="absolute top-16 right-0 bg-white rounded-xl shadow-xl p-4 w-48 hidden">
            <a href="./index.html" class="block py-2 px-3 text-gray-700 hover:bg-purple-50 rounded-lg">ğŸ  Home</a>
            <a href="./admin.html" class="block py-2 px-3 text-gray-700 hover:bg-purple-50 rounded-lg bg-purple-50">âš™ï¸ Admin</a>
            <a href="./counter.html" class="block py-2 px-3 text-gray-700 hover:bg-purple-50 rounded-lg">ğŸ¯ Counter</a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="min-h-screen px-4 py-8 hidden">
        <div class="max-w-md mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 text-center">
                <h1 class="text-3xl font-bold text-gray-800">âš™ï¸ Admin Panel</h1>
                <p class="text-gray-600 mt-2">System configuration</p>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <button id="settingsTab" class="tab-active py-2 px-4 rounded-lg font-semibold transition-all duration-300">Settings</button>
                    <button id="analyticsTab" class="tab-inactive py-2 px-4 rounded-lg font-semibold transition-all duration-300">Analytics</button>
                </div>

                <!-- Settings Tab -->
                <div id="settingsContent">
                    <!-- Queue Settings -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ¯ Queue Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-2">Queue Prefix:</label>
                                <select id="queuePrefix" class="w-full border border-gray-300 p-3 rounded-lg">
                                    <option value="A">A (General)</option>
                                    <option value="B">B (Priority)</option>
                                    <option value="C">C (Special)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-2">Start Number:</label>
                                <input type="number" id="startNumber" value="100" class="w-full border border-gray-300 p-3 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-2">Current Serving Number:</label>
                                <input type="text" id="currentServingInput" placeholder="A001" class="w-full border border-gray-300 p-3 rounded-lg">
                                <button id="setCurrentServingBtn" class="w-full mt-2 py-2 bg-blue-500 text-white font-bold rounded-xl shadow hover:scale-105 transition-all">Set Current Serving</button>
                            </div>
                            <button id="saveSettingsBtn" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
                                ğŸ’¾ Save Settings
                            </button>
                        </div>
                    </div>

                    <!-- Reset Tools -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ”„ Reset Tools</h3>
                        <div class="space-y-3">
                            <input type="text" id="resetToNumber" placeholder="A001 or custom" class="w-full border border-gray-300 p-3 rounded-lg">
                            <button id="resetQueueBtn" class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
                                ğŸ—‘ï¸ Reset Queue
                            </button>
                        </div>
                    </div>

                    <!-- Admin Ad Input -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“¢ Announcement / Promo</h3>
                        <label for="adText" class="block text-sm text-gray-600 mb-2">Ad Message (bottom of status page)</label>
                        <textarea id="adText" class="w-full border border-gray-300 p-3 rounded-lg" rows="3" placeholder="Enter announcement or promo message here..."></textarea>
                        <button id="saveAdBtn" class="w-full mt-2 py-2 bg-purple-500 text-white font-bold rounded-xl shadow hover:scale-105 transition-all">Save Ad</button>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div id="analyticsContent" class="hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š Analytics Overview</h3>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">Today Served</p>
                            <p id="todayServed" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">In Queue</p>
                            <p id="inQueue" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div class="text-center">
                <p id="statusMsg" class="text-sm text-green-600 hidden">âœ… Action completed!</p>
                <p id="errorMsg" class="text-sm text-red-500 hidden">âŒ Error occurred!</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="./js/firebase-config.js"></script>
    
    <!-- Navigation Script -->
    <script src="./js/navigation.js"></script>
    
    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Queue Joy - Admin panel loaded');
            
            // Check if already authenticated
            if (sessionStorage.getItem('adminAuth') === 'true') {
                showMainContent();
            } else {
                initializePinScreen();
            }
        });

        function initializePinScreen() {
            const pinInput = document.getElementById('pinInput');
            const pinSubmit = document.getElementById('pinSubmit');
            const pinCancel = document.getElementById('pinCancel');
            const pinError = document.getElementById('pinError');
            
            pinSubmit.addEventListener('click', () => {
                const pin = pinInput.value;
                if (pin === '0108') {
                    sessionStorage.setItem('adminAuth', 'true');
                    showMainContent();
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.focus();
                }
            });
            
            pinCancel.addEventListener('click', () => {
                window.location.href = './index.html';
            });
            
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    pinSubmit.click();
                }
            });
            
            pinInput.focus();
        }

        function showMainContent() {
            document.getElementById('pinScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('hamburgerMenu').classList.remove('hidden');
            
            // Initialize menu
            initializeNavigation();
            
            // Load settings
            loadSettings();
            
            // Load analytics
            loadAnalytics();
            
            // Set up event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Tab switching
            document.getElementById('settingsTab').addEventListener('click', () => switchTab('settings'));
            document.getElementById('analyticsTab').addEventListener('click', () => switchTab('analytics'));
            
            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // Reset tools
            document.getElementById('resetQueueBtn').addEventListener('click', resetQueue);
            
            // Set current serving
            document.getElementById('setCurrentServingBtn').addEventListener('click', setCurrentServing);
            
            // Save ad
            document.getElementById('saveAdBtn').addEventListener('click', saveAd);
        }

        function switchTab(tab) {
            const settingsTab = document.getElementById('settingsTab');
            const analyticsTab = document.getElementById('analyticsTab');
            const settingsContent = document.getElementById('settingsContent');
            const analyticsContent = document.getElementById('analyticsContent');
            
            if (tab === 'settings') {
                settingsTab.className = 'tab-active py-2 px-4 rounded-lg font-semibold transition-all duration-300';
                analyticsTab.className = 'tab-inactive py-2 px-4 rounded-lg font-semibold transition-all duration-300';
                settingsContent.classList.remove('hidden');
                analyticsContent.classList.add('hidden');
            } else {
                settingsTab.className = 'tab-inactive py-2 px-4 rounded-lg font-semibold transition-all duration-300';
                analyticsTab.className = 'tab-active py-2 px-4 rounded-lg font-semibold transition-all duration-300';
                settingsContent.classList.add('hidden');
                analyticsContent.classList.remove('hidden');
                loadAnalytics(); // Refresh analytics when switching to tab
            }
        }

        function loadSettings() {
            // Load queue format
            firebase.database().ref('settings/queueFormat').once('value', (snapshot) => {
                const settings = snapshot.val() || { prefix: 'A', start: 100 };
                document.getElementById('queuePrefix').value = settings.prefix;
                document.getElementById('startNumber').value = settings.start;
                localStorage.setItem('queuePrefix', settings.prefix);
            });
            // Load current serving
            firebase.database().ref('queue/currentServing').once('value', (snapshot) => {
                const current = snapshot.val() || 'A001';
                document.getElementById('currentServingInput').value = current;
                localStorage.setItem('currentServing', current);
            });
            // Load ad
            firebase.database().ref('settings/adContent').once('value', (snapshot) => {
                const ad = snapshot.val() || '';
                document.getElementById('adText').value = ad;
                localStorage.setItem('adContent', ad);
            });
        }

        function saveSettings() {
            const prefix = document.getElementById('queuePrefix').value;
            const start = parseInt(document.getElementById('startNumber').value);
            const statusMsg = document.getElementById('statusMsg');
            
            const settings = { prefix, start };
            
            firebase.database().ref('settings/queueFormat').set(settings)
                .then(() => {
                    localStorage.setItem('queuePrefix', prefix);
                    statusMsg.textContent = 'âœ… Settings saved successfully!';
                    statusMsg.classList.remove('hidden');
                    setTimeout(() => statusMsg.classList.add('hidden'), 3000);
                })
                .catch((error) => {
                    console.error('Error saving settings:', error);
                    showError('Failed to save settings');
                });
        }

        function loadAnalytics() {
            const today = new Date().toISOString().split('T')[0];
            
            // Load today's queue data
            firebase.database().ref(`queues/${today}`).once('value', (snapshot) => {
                const data = snapshot.val() || {};
                const numbers = data.numbers || {};
                const currentSuffix = data.currentNumberSuffix || 100;
                const lastSuffix = data.lastSuffix || 100;
                
                // Calculate served and in queue
                const served = Math.max(0, currentSuffix - 100);
                const inQueue = Math.max(0, lastSuffix - currentSuffix);
                
                document.getElementById('todayServed').textContent = served;
                document.getElementById('inQueue').textContent = inQueue;
            });
        }

        function resetQueue() {
            const resetVal = document.getElementById('resetToNumber').value.trim();
            if (!resetVal.match(/^[A-Z]\d+$/)) {
                showError('Invalid format. Use e.g. A001');
                return;
            }
            firebase.database().ref('queue/currentServing').set(resetVal)
                .then(() => {
                    localStorage.setItem('currentServing', resetVal);
                    showStatus('Queue reset to ' + resetVal);
                })
                .catch(() => showError('Failed to reset queue.'));
        }

        function setCurrentServing() {
            const val = document.getElementById('currentServingInput').value.trim();
            if (!val.match(/^[A-Z]\d+$/)) {
                showError('Invalid format. Use e.g. A101');
                return;
            }
            firebase.database().ref('queue/currentServing').set(val)
                .then(() => {
                    localStorage.setItem('currentServing', val);
                    showStatus('Current serving updated!');
                })
                .catch(() => showError('Failed to update current serving.'));
        }

        function saveAd() {
            const ad = document.getElementById('adText').value;
            localStorage.setItem('adContent', ad);
            firebase.database().ref('settings/adContent').set(ad)
                .then(() => {
                    showStatus('Ad saved!');
                })
                .catch(() => showError('Failed to save ad.'));
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = 'âŒ ' + message;
            errorMsg.classList.remove('hidden');
            setTimeout(() => errorMsg.classList.add('hidden'), 3000);
        }

        function showStatus(msg) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = 'âœ… ' + msg;
            statusMsg.classList.remove('hidden');
            setTimeout(() => statusMsg.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
